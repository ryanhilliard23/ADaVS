from app.models.asset import Asset
from app.models.asset_service import AssetService
from app.models.scan import Scan
from app.models.vulnerability import Vulnerability
from app.services import vulnerability_services as vs
import pytest


def test_list_vulnerabilities_empty(db_session):
    """Should return empty list when no vulnerabilities exist."""
    result = vs.list_vulnerabilities(db_session, user_id=1)
    assert result == []


def test_list_vulnerabilities_populated(db_session):
    """Should return vulnerability list for given user_id."""
    scan = Scan(status="done", targets="10.0.0.0/24", user_id=7)
    db_session.add(scan)
    db_session.flush()

    asset = Asset(scan_id=scan.id, ip_address="10.0.0.5")
    db_session.add(asset)
    db_session.flush()

    svc = AssetService(asset_id=asset.id, port=80, protocol="tcp", service_name="http")
    db_session.add(svc)
    db_session.flush()

    vuln = Vulnerability(
        service_id=svc.id,
        template_id="V-001",
        severity="medium",
        description="Cross-site issue",
        evidence="header mismatch",
    )
    db_session.add(vuln)
    db_session.commit()

    result = vs.list_vulnerabilities(db_session, user_id=7)
    assert len(result) == 1
    v = result[0]
    assert v["template_id"] == "V-001"
    assert v["severity"] == "medium"


def test_vuln_detail_found(db_session):
    """Should return correct dict when vulnerability exists."""
    v = Vulnerability(
        service_id=5,
        template_id="T-999",
        severity="critical",
        description="overflow",
        evidence="stack trace",
    )
    db_session.add(v)
    db_session.commit()

    out = vs.vuln_detail(db_session, v.id)
    assert out["template_id"] == "T-999"
    assert out["evidence"] == "stack trace"


def test_vuln_detail_not_found(db_session):
    """Should return None for invalid ID."""
    assert vs.vuln_detail(db_session, vuln_id=99999) is None


def test_list_vulns_for_service_empty(db_session):
    """Should return empty list when no vulns for a service."""
    result = vs.list_vulns_for_service(db_session, service_id=123)
    assert result == []


def test_list_vulns_for_service_populated(db_session):
    """Should return list of vulns tied to specific service."""
    v = Vulnerability(
        service_id=11,
        template_id="P-101",
        severity="low",
        description="banner issue",
        evidence="trace info",
    )
    db_session.add(v)
    db_session.commit()

    result = vs.list_vulns_for_service(db_session, service_id=11)
    assert isinstance(result, list)
    assert result[0]["template_id"] == "P-101"
    assert result[0]["severity"] == "low"
