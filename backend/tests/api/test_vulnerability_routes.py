import pytest

def test_list_vulnerabilities_stub_message(client):
    """Check that GET /api/vulnerabilities/ returns stub message or requires auth."""
    r = client.get("/api/vulnerabilities/")
    # Allow 200 (OK) or 401 (Unauthorized) for secured routes
    assert r.status_code in (200, 401)

    if r.status_code == 200:
        data = r.json()
        # Handle stub message or list form
        if isinstance(data, dict):
            assert "message" in data
        elif isinstance(data, list):
            assert isinstance(data, list)


def test_vuln_detail_uses_service_but_returns_stub_message(client, monkeypatch):
    """Ensure vuln_detail route returns stub message correctly."""
    from app.services import vulnerability_services
    monkeypatch.setattr(
        vulnerability_services,
        "vuln_detail",
        lambda db, vid, user_id=None: {"id": vid},
    )

    r = client.get("/api/vulnerabilities/5")
    assert r.status_code == 200
    assert r.json() == {"message": "GET/vulnerabilities/5/ endpoint hit"}


def test_list_vulns_for_service_stub_message(client):
    """Ensure GET /api/vulnerabilities/service/{service_id} works as expected."""
    r = client.get("/api/vulnerabilities/service/9")
    assert r.status_code == 200
    assert r.json() == {"message": "GET/vulnerabilities/service/9/ endpoint hit"}
